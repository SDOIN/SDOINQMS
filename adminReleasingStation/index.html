<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SDOIN QMS - Releasing Station Monitor</title>
  <link rel="icon" type="image/png" href="../images/SDOINLogo.png" />
  <link rel="stylesheet" href="../styles.css" />
  <link rel="stylesheet" href="../admin-modals.css" />
  <script defer src="../script.js"></script>
  <script type="module" src="../firebase-admin.js"></script>
  <style>
    /* Releasing Station Monitor - same layout as receiving */
    .receiving-station-container { display: flex; height: calc(100vh - 60px); overflow: hidden; margin-top: 10px; }
    .left-panel { width: 35%; background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)); display: flex; flex-direction: column; padding: 15px; }
    .logo-title-section { background: #f5f5f5; padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 15px; }
    .logos { display: flex; justify-content: center; gap: 15px; margin-bottom: 10px; }
    .logo-image { height: 40px; object-fit: contain; }
    .bagong-pilipinas-logo { height: 50px; }
    .logo-title-section .system-title { font-size: 20px; font-weight: 600; color: #333; margin-bottom: 5px; text-shadow: none !important; }
    header.top-bar .system-title { color: white; }
    .logo-title-section .system-subtitle { font-size: 14px; font-weight: bold; color: #333; text-shadow: none !important; }
    .navigation-section { background: rgba(44, 44, 44, 0.8); padding: 15px; border-radius: 12px; margin-bottom: 15px; }
    .nav-link { display: block; color: white; text-decoration: none; padding: 10px 14px; margin-bottom: 6px; border-radius: 8px; transition: background 0.3s ease; font-size: 14px; font-weight: 500; }
    .nav-link:hover { background: rgba(255, 255, 255, 0.1); }
    .nav-link.active { background: white; color: #333; font-weight: bold; }
    .queue-monitoring { background: rgba(44, 44, 44, 0.8); padding: 15px; border-radius: 12px; margin-bottom: 15px; }
    .queue-display { display: flex; align-items: center; margin-bottom: 10px; padding: 12px; border-radius: 8px; }
    .queue-display.on-queue { background: #28a745; }
    .queue-display.next-queue { background: #ffc107; color: #000; }
    .queue-label { font-size: 14px; font-weight: bold; margin-right: 15px; color: white; }
    .queue-number { font-size: 28px; font-weight: bold; color: white; }
    .queue-display.next-queue .queue-label,
    .queue-display.next-queue .queue-number {
      color: #000;
    }
    .bottom-info { margin-top: auto; text-align: center; color: #bbb; font-size: 13px; }
    .right-panel { width: 65%; background: #2c2c2c; display: flex; flex-direction: column; }
    .station-header { background: #2c2c2c; padding: 15px; text-align: center; }
    .station-title { font-size: 24px; font-weight: bold; color: white; text-transform: uppercase; letter-spacing: 2px; }
    .queue-list-container { flex: 1; padding: 15px; overflow-y: auto; max-height: calc(100vh - 180px); scroll-behavior: smooth; }
    .queue-item { background: #f8f8f8; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; align-items: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .queue-item-number { font-size: 20px; font-weight: bold; color: #333; margin-right: 15px; min-width: 50px; }
    .queue-item-content { flex: 1; }
    .queue-item-title { font-size: 14px; font-weight: bold; color: #333; margin-bottom: 3px; }
    .queue-item-tracking { font-size: 12px; color: #666; font-family: monospace; }
    .queue-item-status { font-size: 12px; color: #000; font-weight: bold; }
    .queue-item[data-status="on-queue"] { background: #28a745; }
    .queue-item[data-status="next-queue"] { background: white; }
    .queue-item[data-status="pending"] { background: #f8f8f8; }
    .queue-item[data-status="on-queue"] .queue-item-number,
    .queue-item[data-status="on-queue"] .queue-item-title,
    .queue-item[data-status="on-queue"] .queue-item-tracking { color: #fff; }
    .queue-item[data-status="next-queue"] .queue-item-number,
    .queue-item[data-status="next-queue"] .queue-item-title,
    .queue-item[data-status="next-queue"] .queue-item-tracking { color: #000; }
    .queue-item[data-status="on-queue"] .queue-item-status { color: #fff; }
    .queue-item[data-status="next-queue"] .queue-item-status { color: #000; }
    .station-footer { background: transparent; padding: 10px; text-align: center; color: white; font-size: 11px; }
    .queue-list-container::-webkit-scrollbar { width: 8px; }
    .queue-list-container::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 4px; }
    .queue-list-container::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 4px; }
    .queue-list-container::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.5); }
    
    /* Modal close button styles */
    .modal-close-btn { position: absolute; top: 15px; right: 15px; background: transparent; color: black; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 32px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: color 0.3s ease; }
    .modal-close-btn:hover { color: #333; }
    .modal-button-group { display: flex; gap: 15px; justify-content: center; align-items: center; margin-top: 15px; }
    .modal-cancel-button, .modal-return-button { border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s ease; height: 48px; width: 100px; flex: 1; max-width: 100px; display: flex; align-items: center; justify-content: center; box-sizing: border-box; }
    .modal-cancel-button { background: #6c757d; color: white; margin-top: 32px; }
    .modal-cancel-button:hover { background: #5a6268; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .modal-return-button { background: #28a745; color: white; }
    .modal-return-button:hover { background: #218838; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .datetime { font-weight: bold !important; }
  </style>
</head>
<body>
  <!-- Top Bar -->
  <header class="top-bar">
        <div class="system-title"><a href="../" style="color: inherit; text-decoration: none;">SDOIN Queueing Management System</a></div>
    <div style="display:flex; align-items:center; gap:20px;">
      <div class="datetime" id="datetime">Loading...</div>
      <button id="logoutBtn" style="padding:8px 12px; border:none; border-radius:6px; background:#dc3545; color:#fff; font-weight:bold; cursor:pointer; text-transform:uppercase;">LOGOUT</button>
    </div>
  </header>

  <div class="receiving-station-container">
    <!-- Left Panel -->
    <div class="left-panel">
      <!-- Logo and Title Section -->
      <div class="logo-title-section">
        <div class="logos">
          <img src="../images/SDOINLogo.png" alt="SDOIN Logo" class="logo-image" />
          <img src="../images/DEPEDLogo.png" alt="DepED Logo" class="logo-image" />
          <img src="../images/BagongPilipinasLogo.png" alt="Bagong Pilipinas Logo" class="logo-image bagong-pilipinas-logo" />
        </div>
        <div class="system-title">SDO Ilocos Norte</div>
        <div class="system-subtitle">QUEUEING MANAGEMENT SYSTEM</div>
      </div>

      <!-- Navigation Section -->
      <div class="navigation-section">
        <a href="../adminReceivingStation/" class="nav-link">Receiving Station</a>
        <a href="../adminReleasingStation/" class="nav-link active">Releasing Station</a>
      </div>

      <!-- Queue Monitoring Section -->
      <div class="queue-monitoring">
        <div style="text-align: center; margin-bottom: 15px; font-size: 16px; font-weight: bold; color: white;">QUEUE MONITOR (RELEASING)</div>
        <div class="queue-display on-queue">
          <div class="queue-label">ON QUEUE</div>
          <div class="queue-number" id="currentQueue">00</div>
        </div>
        <div class="queue-display next-queue">
          <div class="queue-label">NEXT QUEUE</div>
          <div class="queue-number" id="nextQueue">00</div>
        </div>
      </div>

      <div class="bottom-info">
        <div>Made with ❤️ and ☕</div>
      </div>
    </div>

    <!-- Right Panel -->
    <div class="right-panel">
      <div class="station-header">
        <div class="station-title">RELEASING STATION</div>
      </div>

      <div class="queue-list-container" id="queueList"></div>

    </div>
  </div>

  <script>
    // Protect page - require auth token
    (function enforceAuth(){
      try {
        const token = localStorage.getItem('admin_auth_token');
        const exp = parseInt(localStorage.getItem('admin_auth_exp') || '0', 10);
        if (!token || Date.now() >= exp) {
          window.location.href = '../';
        }
      } catch (e) {
        window.location.href = '../';
      }
    })();
    // Read from releasing queue storage
    function renderFromStorage() {
      const queueList = document.getElementById('queueList');
      queueList.innerHTML = '';
      const list = JSON.parse(localStorage.getItem('releasing_queue') || '[]');
      const pending = list.filter(i => i.status === 'pending');
      const current = pending[0]?.number || '00';
      const next = pending[1]?.number || '00';
      document.getElementById('currentQueue').textContent = String(current).padStart(2,'0');
      document.getElementById('nextQueue').textContent = String(next).padStart(2,'0');
      pending.forEach((item, idx) => {
        const row = document.createElement('div');
        row.className = 'queue-item';
        row.setAttribute('data-id', item.id);
        const status = idx === 0 ? 'on-queue' : (idx === 1 ? 'next-queue' : 'pending');
        const statusText = idx === 0 ? 'ON QUEUE' : (idx === 1 ? 'NEXT' : 'PENDING');
        
        row.innerHTML = `
          <div class="queue-item-number">${String(item.number).padStart(2,'0')}</div>
          <div class="queue-item-content">
            <div class="queue-item-title">DOCUMENT TRACKING NUMBER</div>
            <div class="queue-item-tracking">${item.dts ? item.dts : '—'}</div>
          </div>
          <div class="queue-item-status">${statusText}</div>`;
        row.setAttribute('data-status', status);
        row.addEventListener('click', () => openItemModal(item));
        queueList.appendChild(row);
      });
    }

    window.addEventListener('storage', function(e){ if (e.key==='releasing_queue' || e.key==='releasing_last_update') renderFromStorage(); });

    function updateDateTime(){
      const now = new Date();
      const months=['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
      const month=months[now.getMonth()]; const day=String(now.getDate()).padStart(2,'0'); const year=now.getFullYear();
      let h=now.getHours(); const m=String(now.getMinutes()).padStart(2,'0'); const s=String(now.getSeconds()).padStart(2,'0'); const ap=h>=12?'PM':'AM'; h=String(h%12||12).padStart(2,'0');
      document.getElementById('datetime').textContent=`${month} ${day}, ${year} | ${h}:${m}:${s} ${ap}`;
    }
    setInterval(updateDateTime,1000); updateDateTime();

    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', function(){
      try {
        localStorage.removeItem('admin_auth_token');
        localStorage.removeItem('admin_auth_exp');
      } catch (e) {}
      window.location.href = '../';
    });

    document.addEventListener('DOMContentLoaded', renderFromStorage);

    // Modal for item details
    function openItemModal(item) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay show';
      overlay.innerHTML = `
        <div class="queue-modal">
          <button class="modal-close-btn" id="closeModal">&times;</button>
          <div class="queue-header">QUEUE DETAILS</div>
          <div class="modal-main-content">
            <div class="modal-queue-number">${String(item.number).padStart(2,'0')}</div>
            <div class="modal-message-section">
              <div class="modal-greeting">Document Tracking</div>
              <div class="modal-instructions">${item.dts ? item.dts : 'Not provided'}</div>
            </div>
          </div>
          <div class="modal-button-group">
            <button class="modal-return-button" id="markDone">DONE</button>
            <button class="modal-cancel-button" id="cancelModal">CANCEL</button>
          </div>
          <div class="modal-countdown" style="display:none"></div>
        </div>`;
      document.body.appendChild(overlay);
      overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
      
      // Close button (X)
      document.getElementById('closeModal').addEventListener('click', () => {
        overlay.remove();
      });
      
      // Cancel button - deletes the queue
      document.getElementById('cancelModal').addEventListener('click', () => {
        try {
          const list = JSON.parse(localStorage.getItem('releasing_queue') || '[]');
          const filtered = list.filter(x => x.id !== item.id);
          localStorage.setItem('releasing_queue', JSON.stringify(filtered));
          localStorage.setItem('releasing_last_update', String(Date.now()));
        } catch (e) {}
        overlay.remove();
        renderFromStorage();
      });
      
      // Done button
      document.getElementById('markDone').addEventListener('click', () => {
        try {
          const list = JSON.parse(localStorage.getItem('releasing_queue') || '[]');
          const idx = list.findIndex(x => x.id === item.id);
          if (idx !== -1) {
            list[idx].status = 'done';
            localStorage.setItem('releasing_queue', JSON.stringify(list));
            localStorage.setItem('releasing_last_update', String(Date.now()));
          }
        } catch (e) {}
        overlay.remove();
        renderFromStorage();
      });
    }
  </script>

  <!-- View Details Modal -->
  <div class="modal-overlay" id="viewModal">
    <div class="modal-container">
      <div class="modal-header">
        <button class="modal-close" onclick="closeModal('viewModal')">&times;</button>
        <h2 class="modal-title">Queue Details</h2>
      </div>
      
      <div class="modal-body">
        <div class="modal-details">
          <div class="detail-row">
            <span class="detail-label">Queue Number</span>
            <span class="detail-value" id="viewQueueNumber">--</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">DTS Number</span>
            <span class="detail-value" id="viewDTS">--</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Status</span>
            <span class="detail-value status" id="viewStatus">--</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Created At</span>
            <span class="detail-value" id="viewTimestamp">--</span>
          </div>
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="modal-btn modal-btn-success" onclick="confirmMarkDone()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          Mark as Done
        </button>
        <button class="modal-btn modal-btn-danger" onclick="confirmCancelQueue()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          Cancel Queue
        </button>
        <button class="modal-btn modal-btn-secondary" onclick="closeModal('viewModal')">Close</button>
      </div>
    </div>
  </div>

  <!-- Done Confirmation Modal -->
  <div class="modal-overlay" id="doneModal">
    <div class="modal-container">
      <div class="modal-header">
        <button class="modal-close" onclick="closeModal('doneModal')">&times;</button>
        <h2 class="modal-title">Mark as Done?</h2>
      </div>
      
      <div class="modal-body">
        <p class="modal-message">
          Are you sure you want to mark Queue <span class="modal-queue-highlight" id="doneQueueNumber">--</span> as done ?
          <br><br>
          This action will remove the queue from the list.
        </p>
      </div>
      
      <div class="modal-actions">
        <button class="modal-btn modal-btn-success" onclick="confirmMarkDone()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          Yes, Mark as Done
        </button>
        <button class="modal-btn modal-btn-secondary" onclick="closeModal('doneModal')">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Cancel Confirmation Modal -->
  <div class="modal-overlay" id="cancelModal">
    <div class="modal-container">
      <div class="modal-header">
        <button class="modal-close" onclick="closeModal('cancelModal')">&times;</button>
        <h2 class="modal-title">Cancel Queue?</h2>
      </div>
      
      <div class="modal-body">
        <p class="modal-message">
          Are you sure you want to cancel Queue <span class="modal-queue-highlight" id="cancelQueueNumber">--</span> ?
          <br><br>
          This action cannot be undone.
        </p>
      </div>
      
      <div class="modal-actions">
        <button class="modal-btn modal-btn-danger" onclick="confirmCancelQueue()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          Yes, Cancel Queue
        </button>
        <button class="modal-btn modal-btn-secondary" onclick="closeModal('cancelModal')">No, Keep It</button>
      </div>
    </div>
  </div>

  <!-- Initialize Firebase for this admin page -->
  <script type="module">
    // Initialize Firebase admin functionality
    window.addEventListener('load', function() {
      if (typeof window.initializeFirebaseAdmin === 'function') {
        window.initializeFirebaseAdmin('releasing');
      }
    });
  </script>
</body>
</html>
