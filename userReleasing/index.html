<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SDOIN QMS - Releasing Station</title>
  <link rel="icon" type="image/png" href="../images/SDOINLogo.png" />
  <link rel="stylesheet" href="../styles.css" />
  <script defer src="../script.js"></script>
  <script>
    function submitQueue(event) {
      event.preventDefault();
      const queueNumber = document.getElementById('queueNumber').value;
      const dtsNumber = (document.getElementById('dtsNumber') && document.getElementById('dtsNumber').value.trim()) || '';
      if (!dtsNumber) {
        alert('DTS Number is required.');
        return;
      }
      // Append to persistent queue list
      try {
        const list = JSON.parse(localStorage.getItem('releasing_queue') || '[]');
        const existsActive = list.some(it => it.number === String(queueNumber) && it.status !== 'done');
        if (existsActive) {
          alert('This queue number is already pending/processing. Please mark it done first.');
          return;
        }
        const item = {
          id: Date.now(),
          number: String(queueNumber),
          dts: String(dtsNumber || ''),
          status: 'pending',
          createdAt: Date.now()
        };
        list.push(item);
        localStorage.setItem('releasing_queue', JSON.stringify(list));
        localStorage.setItem('releasing_last_update', String(Date.now()));
      } catch (e) {}
      
      // Show modal with queue number
      document.getElementById('modalQueueNumber').textContent = queueNumber;
      showModal();
      
      // Clear form
      document.getElementById('queueNumber').value = '';
      document.getElementById('dtsNumber').value = '';
    }

    function showModal() {
      const modal = document.getElementById('queueModal');
      modal.classList.add('show');
      
      // Start countdown
      let timeLeft = 10;
      const timerElement = document.getElementById('modalTimer');
      const countdownElement = document.getElementById('modalCountdown');
      
      function updateTimer() {
        timerElement.textContent = timeLeft;
        if (timeLeft <= 0) {
          closeModal();
        } else {
          timeLeft--;
          setTimeout(updateTimer, 1000);
        }
      }
      
      updateTimer();
      
      // Hide countdown after 2 seconds
      setTimeout(() => {
        countdownElement.style.opacity = '0.7';
      }, 2000);
    }

    function closeModal() {
      const modal = document.getElementById('queueModal');
      modal.classList.remove('show');
    }

    // Close modal when clicking outside
    document.getElementById('queueModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });

    // Input validation for queue number (numbers only)
    document.getElementById('queueNumber').addEventListener('input', function(e) {
      // Remove any non-numeric characters
      this.value = this.value.replace(/[^0-9]/g, '');
    });

    // Prevent non-numeric characters on keypress
    document.getElementById('queueNumber').addEventListener('keypress', function(e) {
      // Allow: backspace, delete, tab, escape, enter
      if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
          // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
          (e.keyCode === 65 && e.ctrlKey === true) ||
          (e.keyCode === 67 && e.ctrlKey === true) ||
          (e.keyCode === 86 && e.ctrlKey === true) ||
          (e.keyCode === 88 && e.ctrlKey === true)) {
        return;
      }
      // Ensure that it is a number and stop the keypress
      if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
        e.preventDefault();
      }
    });
  </script>
  
  <style>
    .station-btn {
      background: #2c2c2c !important;
      color: white !important;
    }
    
    .station-btn.active {
      background: white !important;
      color: #333 !important;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <!-- Top Bar -->
  <header class="top-bar">
        <div class="system-title"><a href="../" style="color: inherit; text-decoration: none;">SDOIN Queueing Management System</a></div>
    <div class="datetime" id="datetime">Loading...</div>
  </header>

  <!-- Main Section -->
  <main class="main-content-section">
    <!-- Left Section -->
    <section class="left-section">
      <!-- Title and Logos -->
      <div class="title-logos-section">
        <div class="logos">
          <img src="../images/SDOINLogo.png" alt="SDOIN Logo" class="logo-image" />
          <img src="../images/DEPEDLogo.png" alt="DepED Logo" class="logo-image" />
          <img src="../images/BagongPilipinasLogo.png" alt="Bagong Pilipinas Logo" class="logo-image bagong-pilipinas-logo" />
        </div>
        <div class="main-title">
          <h1>Schools Division of Ilocos Norte</h1>
          <h2>QUEUEING MANAGEMENT SYSTEM</h2>
        </div>
      </div>

      <!-- Instructions -->
      <div class="instructions">
        <div class="steps-horizontal">
          <!-- Step 1 -->
          <div class="step">
            <div class="step-visual">
              <div class="card-icon">
                <div class="card-number">00</div>
                <div class="card-label">RELEASING STATION</div>
              </div>
            </div>
            <div class="step-title">GET A QUEUEING NUMBER CARD</div>
          </div>

          <!-- Step 2 -->
          <div class="step">
            <div class="step-visual">
              <div class="input-icon">
                <div class="input-field">QUEUEING NUMBER</div>
                <div class="input-field">DTS NUMBER</div>
              </div>
            </div>
            <div class="step-title">INPUT THE QUEUEING NUMBER AND DTS NUMBER</div>
          </div>

          <!-- Step 3 -->
          <div class="step">
            <div class="step-visual">
              <div class="screen-icon">
                <div class="screen-number">00</div>
                <div class="screen-label">RELEASING STATION</div>
              </div>
            </div>
            <div class="step-title">WAIT FOR YOUR QUEUEING NUMBER ON THE SCREEN</div>
          </div>
        </div>
      </div>

      <!-- Buttons -->
      <div class="station-buttons">
        <button class="station-btn receiving" onclick="window.location.href='../userReceiving/'">RECEIVING STATION</button>
        <button class="station-btn releasing active" onclick="window.location.href='../userReleasing/'">RELEASING STATION</button>
      </div>
    </section>

    <!-- Right Section -->
    <aside class="right-section">
      <div class="form-panel" style="text-align: center;">
        <h1>RELEASING STATION</h1>
        <p class="form-instruction">
          Kindly fill out the following fields below.<br />
          Please disregard the DTS Number if none.
        </p>

        <form class="queue-form" id="queueForm" onsubmit="submitQueue(event)">
          <div class="form-group">
            <label for="queueNumber">QUEUEING NUMBER</label>
            <input type="text" id="queueNumber" placeholder="Enter Your Queue number" required pattern="[0-9]+" title="Please enter numbers only" />
          </div>

          <div class="form-group">
            <label for="dtsNumber">DTS NUMBER *</label>
            <input type="text" id="dtsNumber" placeholder="Enter Your DTS Number" required />
          </div>

          <button type="submit" class="add-to-queue-btn">ADD TO QUEUE</button>
        </form>
      </div>
    </aside>
  </main>

  <!-- Queue Display Modal -->
  <div class="modal-overlay" id="queueModal">
    <div class="queue-modal">
      <div class="queue-header">QUEUE NUMBER</div>
      
      <div class="modal-main-content">
        <div class="modal-queue-number" id="modalQueueNumber">01</div>
        
        <div class="modal-message-section">
          <div class="modal-greeting">Great Day!</div>
          <div class="modal-instructions">Kindly keep the card in good condition.</div>
          <div class="modal-instructions">Wait for your Queue Number in the Screen.</div>
          <div class="modal-instructions">Thank you!</div>
        </div>
      </div>

      <div class="modal-note-bar">
        Note: Please refer to the screen for your <strong>CARD QUEUE NUMBER.</strong>
      </div>

      <button class="modal-return-button" onclick="closeModal()">RETURN TO MAIN</button>
      
      <div class="modal-countdown" id="modalCountdown">
        Returning automatically in <span id="modalTimer">10</span> seconds...
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <p>Made with ❤️ and ☕ </p>
  </footer>
</body>
</html>
