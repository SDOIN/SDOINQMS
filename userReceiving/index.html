<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SDOIN QMS - Receiving Station</title>
  <link rel="icon" type="image/png" href="../images/SDOINLogo.png" />
  <link rel="stylesheet" href="../styles.css" />
  <script defer src="../script.js"></script>
  <script type="module">
    // Import Firebase modules
    import { database, ref, push, onValue, set, query, orderByChild } from '../firebase-config.js';

    // =============================
    // RFID Card Detection System
    // =============================
    let rfidBuffer = '';
    let rfidTimeout;
    let isProcessingRFID = false;

    // Function to show error message
    function showRFIDError(message) {
      showCustomError('RFID Card Not Recognized', message);
    }

    // Function to show custom error modal (replaces alert)
    function showCustomError(title, message) {
      // Remove existing error if any
      const existingError = document.getElementById('customError');
      if (existingError) {
        existingError.remove();
      }

      // Create error message
      const errorDiv = document.createElement('div');
      errorDiv.id = 'customError';
      errorDiv.className = 'custom-error-modal';
      errorDiv.innerHTML = `
        <div class="custom-error-content">
          <span class="custom-error-icon">‚ö†Ô∏è</span>
          <div class="custom-error-text">
            <strong>${title}</strong>
            <p>${message}</p>
          </div>
          <button class="custom-error-close" onclick="this.parentElement.parentElement.remove()">‚úï</button>
        </div>
      `;
      
      document.body.appendChild(errorDiv);
      
      // Auto-remove after 6 seconds
      setTimeout(() => {
        if (errorDiv.parentElement) {
          errorDiv.remove();
        }
      }, 6000);
    }

    // Function to look up RFID card and get queue number
    async function lookupRFIDCard(rfidId) {
      if (isProcessingRFID) return;
      isProcessingRFID = true;
      
      console.log('üè∑Ô∏è RFID detected:', rfidId);
      
      const rfidRef = ref(database, `rfid_cards/${rfidId}`);
      
      onValue(rfidRef, (snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          const queueNumber = data.queueNumber;
          
          // Auto-fill the queue number
          const queueInput = document.getElementById('queueNumber');
          if (queueInput) {
            queueInput.value = queueNumber;
            queueInput.classList.add('rfid-success');
            
            // Remove success class after animation
            setTimeout(() => {
              queueInput.classList.remove('rfid-success');
            }, 600);
            
            // Show success feedback
            console.log(`‚úÖ RFID ${rfidId} ‚Üí Queue #${queueNumber}`);
            
            // Optional: Focus on DTS number field
            const dtsInput = document.getElementById('dtsNumber');
            if (dtsInput) {
              setTimeout(() => dtsInput.focus(), 300);
            }
          }
        } else {
          // RFID card not found - show error
          showRFIDError(`This RFID card is not registered in the system. Please contact staff for assistance.`);
          console.error('‚ùå RFID not found:', rfidId);
          
          // Optional: Play error sound
          // You can add: new Audio('error-sound.mp3').play();
        }
        
        isProcessingRFID = false;
      }, { onlyOnce: true });
    }

    // Fullscreen loading functions
    function showFullscreenLoading(message = 'Loading...') {
      // Remove existing loading if any
      const existingLoading = document.getElementById('fullscreenLoading');
      if (existingLoading) {
        existingLoading.remove();
      }

      const loadingOverlay = document.createElement('div');
      loadingOverlay.id = 'fullscreenLoading';
      loadingOverlay.className = 'fullscreen-loading';
      
      loadingOverlay.innerHTML = `
        <div class="loading-content">
          <div class="circular-spinner">
            <div class="spinner-dot"></div>
            <div class="spinner-dot"></div>
            <div class="spinner-dot"></div>
            <div class="spinner-dot"></div>
            <div class="spinner-dot"></div>
            <div class="spinner-dot"></div>
            <div class="spinner-dot"></div>
            <div class="spinner-dot"></div>
            <div class="spinner-dot"></div>
            <div class="spinner-dot"></div>
            <div class="spinner-dot"></div>
            <div class="spinner-dot"></div>
          </div>
          <div class="loading-message">${message}</div>
        </div>
      `;
      
      document.body.appendChild(loadingOverlay);
    }

    function hideFullscreenLoading() {
      const loadingOverlay = document.getElementById('fullscreenLoading');
      if (loadingOverlay) {
        loadingOverlay.remove();
      }
    }

    // Make functions globally available
    window.submitQueue = async function(event) {
      event.preventDefault();
      
      const queueNumber = document.getElementById('queueNumber').value.trim();
      const dtsNumber = (document.getElementById('dtsNumber') && document.getElementById('dtsNumber').value) || '';
      
      // Silent validation - just return without alert if empty
      if (!queueNumber) {
        return;
      }
      
      // Show loading
      showFullscreenLoading('Adding to queue...');
      
      try {
        // Check if queue number already exists
        const queueRef = ref(database, 'receiving_queue');
        const snapshot = await new Promise((resolve) => {
          onValue(queueRef, resolve, { onlyOnce: true });
        });
        
        let existsActive = false;
        if (snapshot.exists()) {
          const data = snapshot.val();
          Object.values(data).forEach(item => {
            if (item.number === String(queueNumber) && item.status !== 'done') {
              existsActive = true;
            }
          });
        }
        
        if (existsActive) {
          hideFullscreenLoading();
          showCustomError('This Number is Already in Queue', 'Please get another number.');
          return;
        }
        
        // Add new queue item to Firebase
        const newQueueRef = push(queueRef);
        await set(newQueueRef, {
          id: newQueueRef.key,
          number: String(queueNumber),
          dts: String(dtsNumber || ''),
          status: 'waiting',
          createdAt: Date.now()
        });
        
        // Auto-set as "next" if no serving and no next queue exists
        const stateRef = ref(database, 'receiving_state');
        const stateSnapshot = await new Promise((resolve) => {
          onValue(stateRef, resolve, { onlyOnce: true });
        });
        
        const currentState = stateSnapshot.exists() ? stateSnapshot.val() : {};
        
        console.log('üìù Current State:', currentState);
        console.log('üÜï New Queue Key:', newQueueRef.key);
        
        // If both serving and next are empty, set this as next
        if (!currentState.serving && !currentState.next) {
          await set(ref(database, 'receiving_state/next'), newQueueRef.key);
          console.log('‚úÖ Auto-assigned Queue #' + queueNumber + ' as NEXT QUEUE (Key: ' + newQueueRef.key + ')');
        } else {
          console.log('‚ÑπÔ∏è State already has serving or next:', { 
            serving: currentState.serving, 
            next: currentState.next 
          });
        }
        
        // Show modal with queue number
        document.getElementById('modalQueueNumber').textContent = queueNumber;
        showModal();
        
        // Clear form
        document.getElementById('queueNumber').value = '';
        document.getElementById('dtsNumber').value = '';
        
        hideFullscreenLoading();
      } catch (error) {
        hideFullscreenLoading();
        console.error('Error adding queue:', error);
        showCustomError('Error', 'Failed to add queue. Please try again.');
      }
    }

    window.showModal = function() {
      const modal = document.getElementById('queueModal');
      modal.classList.add('show');
      
      // Start countdown
      let timeLeft = 10;
      const timerElement = document.getElementById('modalTimer');
      const countdownElement = document.getElementById('modalCountdown');
      
      function updateTimer() {
        timerElement.textContent = timeLeft;
        if (timeLeft <= 0) {
          closeModal();
        } else {
          timeLeft--;
          setTimeout(updateTimer, 1000);
        }
      }
      
      updateTimer();
      
      // Hide countdown after 2 seconds
      setTimeout(() => {
        countdownElement.style.opacity = '0.7';
      }, 2000);
    }

    window.closeModal = function() {
      const modal = document.getElementById('queueModal');
      modal.classList.remove('show');
    }

    // Wait for DOM to load
    document.addEventListener('DOMContentLoaded', function() {
      // Close modal when clicking outside
      document.getElementById('queueModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeModal();
        }
      });

      // Input validation for queue number (numbers only)
      document.getElementById('queueNumber').addEventListener('input', function(e) {
        // Remove any non-numeric characters
        this.value = this.value.replace(/[^0-9]/g, '');
      });

      // Prevent non-numeric characters on keypress
      document.getElementById('queueNumber').addEventListener('keypress', function(e) {
        // Allow: backspace, delete, tab, escape, enter
        if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
            // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
            (e.keyCode === 65 && e.ctrlKey === true) ||
            (e.keyCode === 67 && e.ctrlKey === true) ||
            (e.keyCode === 86 && e.ctrlKey === true) ||
            (e.keyCode === 88 && e.ctrlKey === true)) {
          return;
        }
        // Ensure that it is a number and stop the keypress
        if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
          e.preventDefault();
        }
      });

      // =============================
      // RFID Scan Detection Listener
      // =============================
      let lastKeypressTime = Date.now();
      
      document.addEventListener('keydown', function(e) {
        const currentTime = Date.now();
        const timeDiff = currentTime - lastKeypressTime;
        lastKeypressTime = currentTime;
        
        // RFID scanners type very fast (< 50ms between characters)
        const isFastTyping = timeDiff < 50;
        
        if (e.key === 'Enter') {
          // RFID readers send Enter after card number
          if (rfidBuffer.length >= 8) {
            e.preventDefault();
            e.stopPropagation();
            
            // Process as RFID scan - ONLY fill the field, don't submit
            lookupRFIDCard(rfidBuffer.trim());
            
            // Clear buffer
            rfidBuffer = '';
            
            // Don't auto-submit - let user press Enter again or click button
            return false;
          }
        } else if (e.key.length === 1) { // Only single characters
          // Build up the RFID buffer
          rfidBuffer += e.key;
          
          // If typing fast, it's likely an RFID scan - prevent default
          if (isFastTyping && rfidBuffer.length > 3) {
            e.preventDefault();
            e.stopPropagation();
          }
          
          // Clear buffer after 200ms of no input
          clearTimeout(rfidTimeout);
          rfidTimeout = setTimeout(() => {
            rfidBuffer = '';
          }, 200);
        }
      });
      
      // Additional safeguard: detect if a long number is pasted/typed into queue number field
      document.getElementById('queueNumber').addEventListener('input', function(e) {
        // If a long number (likely RFID) is in the field, check if it's an RFID card
        if (this.value.length >= 8) {
          const possibleRFID = this.value;
          
          // Check if this is an RFID card
          const rfidRef = ref(database, `rfid_cards/${possibleRFID}`);
          onValue(rfidRef, (snapshot) => {
            if (snapshot.exists()) {
              const data = snapshot.val();
              // Replace the RFID with the queue number
              this.value = data.queueNumber;
              this.classList.add('rfid-success');
              setTimeout(() => {
                this.classList.remove('rfid-success');
              }, 600);
              
              // Focus on DTS field
              const dtsInput = document.getElementById('dtsNumber');
              if (dtsInput) {
                setTimeout(() => dtsInput.focus(), 300);
              }
            }
          }, { onlyOnce: true });
        }
      });
      
      console.log('üè∑Ô∏è RFID detection system active - Ready to scan cards');
    });
  </script>
  
  <style>
    .station-btn {
      background: #2c2c2c !important;
      color: white !important;
    }
    
    .station-btn.active {
      background: white !important;
      color: #333 !important;
      font-weight: bold;
    }

    /* RFID Success Animation */
    @keyframes rfidSuccess {
      0% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
      }
      50% { 
        transform: scale(1.02);
        box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
      }
      100% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
      }
    }

    input.rfid-success {
      animation: rfidSuccess 0.6s ease;
      background: #e8f5e9 !important;
      border-color: #4caf50 !important;
      transition: all 0.3s ease;
    }

    /* Custom Error Modal */
    .custom-error-modal {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        transform: translateX(-50%) translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    .custom-error-content {
      background: #fff;
      border: 2px solid #f44336;
      border-radius: 10px;
      padding: 20px 25px;
      box-shadow: 0 4px 20px rgba(244, 67, 54, 0.3);
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 12px;
      min-width: 400px;
      max-width: 600px;
    }

    .custom-error-icon {
      font-size: 32px;
      flex-shrink: 0;
    }

    .custom-error-text {
      flex: 1;
      text-align: center;
    }

    .custom-error-text strong {
      display: block;
      color: #d32f2f;
      font-size: 16px;
      margin-bottom: 5px;
    }

    .custom-error-text p {
      color: #666;
      font-size: 14px;
      margin: 0;
    }

    .custom-error-close {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      color: #999;
      font-size: 22px;
      cursor: pointer;
      padding: 4px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .custom-error-close:hover {
      background: #f5f5f5;
      color: #333;
    }

    @media (max-width: 768px) {
      .custom-error-content {
        min-width: 300px;
        max-width: 90vw;
        padding: 15px 20px;
      }

      .custom-error-icon {
        font-size: 24px;
      }

      .custom-error-text strong {
        font-size: 14px;
      }

      .custom-error-text p {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <!-- Top Bar -->
  <header class="top-bar">
        <div class="system-title"><a href="../" style="color: inherit; text-decoration: none;">SDOIN Queueing Management System</a></div>
    <div class="datetime" id="datetime">Loading...</div>
  </header>

  <!-- Main Section -->
  <main class="main-content-section">
    <!-- Left Section -->
    <section class="left-section">
      <!-- Title and Logos -->
      <div class="title-logos-section">
        <div class="logos">
          <img src="../images/SDOINLogo.png" alt="SDOIN Logo" class="logo-image" />
          <img src="../images/DEPEDLogo.png" alt="DepED Logo" class="logo-image" />
          <img src="../images/BagongPilipinasLogo.png" alt="Bagong Pilipinas Logo" class="logo-image bagong-pilipinas-logo" />
        </div>
        <div class="main-title">
          <h1>Schools Division of Ilocos Norte</h1>
          <h2>QUEUEING MANAGEMENT SYSTEM</h2>
        </div>
      </div>

      <!-- Instructions -->
      <div class="instructions">
        <div class="steps-horizontal">
          <!-- Step 1 -->
          <div class="step">
            <div class="step-visual">
              <div class="card-icon">
                <div class="card-number">00</div>
                <div class="card-label">RECEIVING STATION</div>
              </div>
            </div>
            <div class="step-title">GET A QUEUEING NUMBER CARD</div>
          </div>

          <!-- Step 2 -->
          <div class="step">
            <div class="step-visual">
              <div class="input-icon">
                <div class="input-field">QUEUEING NUMBER</div>
                <div class="input-field">DTS NUMBER</div>
              </div>
            </div>
            <div class="step-title">INPUT THE QUEUEING NUMBER AND DTS NUMBER</div>
          </div>

          <!-- Step 3 -->
          <div class="step">
            <div class="step-visual">
              <div class="screen-icon">
                <div class="screen-number">00</div>
                <div class="screen-label">RECEIVING STATION</div>
              </div>
            </div>
            <div class="step-title">WAIT FOR YOUR QUEUEING NUMBER ON THE SCREEN</div>
          </div>
        </div>
      </div>

      <!-- Buttons -->
      <div class="station-buttons">
        <button class="station-btn receiving active" onclick="window.location.href='../userReceiving/'">RECEIVING STATION</button>
        <button class="station-btn releasing" onclick="window.location.href='../userReleasing/'">RELEASING STATION</button>
      </div>
    </section>

    <!-- Right Section -->
    <aside class="right-section">
      <div class="form-panel" style="text-align: center;">
        <h1>RECEIVING STATION</h1>
        <p class="form-instruction">
          Kindly fill out the following fields below.<br />
          Please disregard the DTS Number if none.
        </p>

        <form class="queue-form" id="queueForm" onsubmit="submitQueue(event)" novalidate>
          <div class="form-group">
            <label for="queueNumber">QUEUEING NUMBER</label>
            <input type="text" id="queueNumber" placeholder="Enter Your Queue Number" pattern="[0-9]+" title="Please enter numbers only" />
          </div>

          <div class="form-group">
            <label for="dtsNumber">DTS NUMBER (Leave blank if none)</label>
            <input type="text" id="dtsNumber" placeholder="Enter Your DTS Number" />
          </div>

          <button type="submit" class="add-to-queue-btn">ADD TO QUEUE</button>
        </form>
      </div>
    </aside>
  </main>

  <!-- Queue Display Modal -->
  <div class="modal-overlay" id="queueModal">
    <div class="queue-modal">
      <div class="queue-header">QUEUE NUMBER</div>
      
      <div class="modal-main-content">
        <div class="modal-queue-number" id="modalQueueNumber">01</div>
        
        <div class="modal-message-section">
          <div class="modal-greeting">Great Day!</div>
          <div class="modal-instructions">Kindly keep the card in good condition.</div>
          <div class="modal-instructions">Wait for your Queue Number in the Screen.</div>
          <div class="modal-instructions">Thank you!</div>
        </div>
      </div>

      <div class="modal-note-bar">
        Note: Please refer to the screen for your <strong>CARD QUEUE NUMBER.</strong>
      </div>

      <button class="modal-return-button" onclick="closeModal()">RETURN TO MAIN</button>
      
      <div class="modal-countdown" id="modalCountdown">
        Returning automatically in <span id="modalTimer">10</span> seconds...
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <p>Made with üíõ and ‚òï </p>
  </footer>
</body>
</html>
