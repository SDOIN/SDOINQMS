<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SDOIN QMS - Queue Monitor</title>
  <link rel="icon" type="image/png" href="../images/SDOINLogo.png" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url('../images/SDOINBackground.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: white;
      height: 100vh;
      overflow: hidden;
    }

    /* Header */
    .main-header {
      background: #2c2c2c;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .header-title {
      font-size: 16px;
      font-weight: bold;
      color: white;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .header-title a {
      color: inherit;
      text-decoration: none;
    }

    .header-datetime {
      font-size: 14px;
      font-weight: bold;
      color: white;
    }

    /* Main Container */
    .container {
      height: calc(100vh - 48px);
      padding: 20px;
      display: flex;
      gap: 20px;
    }

    /* Station Column */
    .station {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    /* Station Header */
    .station-header {
      background: rgba(44, 44, 44, 0.95);
      padding: 15px;
      text-align: center;
      border-radius: 8px;
      font-size: 24px;
      font-weight: bold;
      letter-spacing: 3px;
      text-transform: uppercase;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }

    /* Queue Grid */
    .queue-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 10px;
      flex: 1;
      overflow: hidden;
      padding: 5px;
      align-content: start;
    }

    .releasing .queue-grid {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }

    /* Queue Number Box */
    .queue-number {
      background: rgba(44, 44, 44, 0.95);
      padding: 15px 10px;
      text-align: center;
      border-radius: 8px;
      font-size: 28px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 60px;
      height: fit-content;
    }

    /* Status Panel */
    .status-panel {
      background: rgba(44, 44, 44, 0.95);
      padding: 15px;
      border-radius: 8px;
      display: flex;
      gap: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }

    .status-box {
      flex: 1;
      text-align: center;
      padding: 20px 15px;
      border-radius: 6px;
    }

    .status-box.on-queue {
      background: #2f8b2f;
      flex: 1.5;
    }

    .status-box.next-queue {
      background: transparent;
    }

    .status-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      margin-bottom: 8px;
      opacity: 0.9;
    }

    .status-number {
      font-size: 48px;
      font-weight: bold;
      line-height: 1;
    }

    /* Scrollbar Styling */
    .queue-grid::-webkit-scrollbar {
      width: 8px;
    }

    .queue-grid::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }

    .queue-grid::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }

    .queue-grid::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* Responsive */
    @media (max-width: 900px) {
      .container {
        flex-direction: column;
      }
      
      .queue-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .status-number {
        font-size: 36px;
      }
    }

    @media (max-width: 768px) {
      .main-header {
        padding: 8px 10px;
      }

      .header-title {
        font-size: 10px;
      }

      .header-datetime {
        font-size: 9px;
      }

      .station-header {
        font-size: 16px;
        padding: 10px;
      }

      .queue-display {
        padding: 8px;
      }

      .queue-label {
        font-size: 10px;
      }

      .status-label {
        font-size: 9px;
      }

      .status-number,
      .queue-number {
        font-size: 20px;
      }

      .queue-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
      }
    }

    /* Extra-small devices: tighten header text sizes */
    @media (max-width: 480px) {
      .main-header {
        padding: 6px 8px;
      }
      .header-title {
        font-size: 9px;
        letter-spacing: 0.5px;
        white-space: nowrap;
      }
      .header-datetime {
        font-size: 8px;
        white-space: nowrap;
      }
    }

    @media (max-width: 360px) {
      .header-title {
        font-size: 8px;
        letter-spacing: 0.3px;
      }
      .header-datetime {
        font-size: 7px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="main-header">
    <div class="header-title"><a href="../">SDOIN Queueing Management System</a></div>
    <div class="header-datetime" id="headerDateTime">Loading...</div>
  </header>

  <!-- Main Container -->
  <div class="container">
    <!-- Receiving Station -->
    <div class="station receiving">
      <div class="station-header">RECEIVING STATION</div>
      
      <div class="status-panel">
        <div class="status-box on-queue">
          <div class="status-label">ON QUEUE</div>
          <div class="status-number" id="recvOnQueue">--</div>
        </div>
        <div class="status-box next-queue">
          <div class="status-label">NEXT QUEUE</div>
          <div class="status-number" id="recvNext">--</div>
        </div>
      </div>

      <div class="queue-grid" id="receivingTickets">
        <!-- Populated by JavaScript -->
      </div>
    </div>

    <!-- Releasing Station -->
    <div class="station releasing">
      <div class="station-header">RELEASING STATION</div>
      
      <div class="status-panel">
        <div class="status-box on-queue">
          <div class="status-label">ON QUEUE</div>
          <div class="status-number" id="relOnQueue">--</div>
        </div>
        <div class="status-box next-queue">
          <div class="status-label">NEXT QUEUE</div>
          <div class="status-number" id="relNext">--</div>
        </div>
      </div>

      <div class="queue-grid" id="releasingTickets">
        <!-- Populated by JavaScript -->
      </div>
    </div>
  </div>

  <script type="module">
    // Import Firebase modules
    import { database, ref, onValue } from '../firebase-config.js';

    // Function to update date/time
    function updateDateTime() {
      const now = new Date();
      const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN',
                      'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
      const month = months[now.getMonth()];
      const day = now.getDate().toString().padStart(2, '0');
      const year = now.getFullYear();

      let hours = now.getHours();
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const seconds = now.getSeconds().toString().padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = (hours % 12 || 12).toString().padStart(2, '0');

      const dateString = `${month} ${day}, ${year}`;
      const timeString = `${hours}:${minutes}:${seconds} ${ampm}`;

      document.getElementById('headerDateTime').textContent = `${dateString} | ${timeString}`;
    }

    // Render queue numbers from Firebase (excluding serving/next)
    function renderTickets(containerId, queueData, currentNumber, nextNumber) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      
      if (!queueData || queueData.length === 0) {
        return;
      }

      // Filter out current and next queue numbers from pending display
      const pendingQueue = queueData.filter(item => {
        const itemNumber = item.number || item.queueNumber;
        return itemNumber !== currentNumber && itemNumber !== nextNumber;
      });

      // Calculate dynamic sizing based on number of items
      const itemCount = pendingQueue.length;
      let fontSize = '28px';
      let padding = '15px 10px';
      let minHeight = '60px';
      
      if (itemCount > 20) {
        fontSize = '18px';
        padding = '8px 6px';
        minHeight = '40px';
      } else if (itemCount > 15) {
        fontSize = '20px';
        padding = '10px 8px';
        minHeight = '45px';
      } else if (itemCount > 10) {
        fontSize = '24px';
        padding = '12px 8px';
        minHeight = '50px';
      }

      pendingQueue.forEach(item => {
        const queueBox = document.createElement('div');
        queueBox.className = 'queue-number';
        queueBox.style.fontSize = fontSize;
        queueBox.style.padding = padding;
        queueBox.style.minHeight = minHeight;
        queueBox.textContent = item.number || item.queueNumber;
        container.appendChild(queueBox);
      });
    }

    // Manual-control aware monitor: reads <station>_queue and <station>_state
    const caches = {
      receiving: { list: [], byKey: {}, state: { serving: null, next: null } },
      releasing: { list: [], byKey: {}, state: { serving: null, next: null } }
    };

    function renderStation(station) {
      const { list, byKey, state } = caches[station];
      const servingKey = state.serving?.firebaseKey || state.serving || null;
      const nextKey = state.next?.firebaseKey || state.next || null;

      const servingItem = servingKey ? byKey[servingKey] : null;
      const nextItem = nextKey ? byKey[nextKey] : null;

      const currentNum = servingItem?.number || servingItem?.queueNumber || '--';
      const nextNum = nextItem?.number || nextItem?.queueNumber || '--';

      if (station === 'receiving') {
        document.getElementById('recvOnQueue').textContent = currentNum || '--';
        document.getElementById('recvNext').textContent = nextNum || '--';
        const pending = list.filter(i => i.firebaseKey !== servingKey && i.firebaseKey !== nextKey);
        renderTickets('receivingTickets', pending, currentNum, nextNum);
      } else {
        document.getElementById('relOnQueue').textContent = currentNum || '--';
        document.getElementById('relNext').textContent = nextNum || '--';
        const pending = list.filter(i => i.firebaseKey !== servingKey && i.firebaseKey !== nextKey);
        renderTickets('releasingTickets', pending, currentNum, nextNum);
      }
    }

    function initializeFirebaseListeners() {
      ['receiving', 'releasing'].forEach((station) => {
        const qRef = ref(database, `${station}_queue`);
        const sRef = ref(database, `${station}_state`);

        onValue(qRef, (snapshot) => {
          const list = [];
          const map = {};
          if (snapshot.exists()) {
            const data = snapshot.val();
            Object.keys(data).forEach(key => {
              const item = { ...data[key], firebaseKey: key };
              if ((item.status || 'waiting') === 'waiting') {
                list.push(item);
                map[key] = item;
              }
            });
            list.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
          }
          caches[station].list = list;
          caches[station].byKey = map;
          renderStation(station);
        });

        onValue(sRef, (snapshot) => {
          const st = snapshot.exists() ? (snapshot.val() || {}) : {};
          caches[station].state = { serving: st.serving || null, next: st.next || null };
          renderStation(station);
        });
      });
    }

    // Initialize on DOM load
    document.addEventListener('DOMContentLoaded', function() {
      updateDateTime();
      setInterval(updateDateTime, 1000);
      
      // Initialize Firebase real-time listeners
      initializeFirebaseListeners();
    });
  </script>
</body>
</html>