<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SDOIN QMS - Queue Monitor</title>
  <link rel="icon" type="image/png" href="../images/SDOINLogo.png" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url('../images/SDOINBackground.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: white;
      height: 100vh;
      overflow: hidden;
    }

    /* Header */
    .main-header {
      background: #2c2c2c;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .header-title {
      font-size: 16px;
      font-weight: bold;
      color: white;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .header-title a {
      color: inherit;
      text-decoration: none;
    }

    .header-datetime {
      font-size: 14px;
      font-weight: bold;
      color: white;
    }

    /* Main Container */
    .container {
      height: calc(100vh - 48px);
      padding: 20px;
      display: flex;
      gap: 20px;
    }

    /* Station Column */
    .station {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    /* Station Header */
    .station-header {
      background: rgba(44, 44, 44, 0.95);
      padding: 15px;
      text-align: center;
      border-radius: 8px;
      font-size: 24px;
      font-weight: bold;
      letter-spacing: 3px;
      text-transform: uppercase;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }

    /* Queue Grid */
    .queue-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 10px;
      flex: 1;
      overflow: hidden;
      padding: 5px;
      align-content: start;
    }

    .releasing .queue-grid {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }

    /* Queue Number Box */
    .queue-number {
      background: rgba(44, 44, 44, 0.95);
      padding: 15px 10px;
      text-align: center;
      border-radius: 8px;
      font-size: 28px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 60px;
      height: fit-content;
    }

    /* Status Panel */
    .status-panel {
      background: rgba(44, 44, 44, 0.95);
      padding: 15px;
      border-radius: 8px;
      display: flex;
      gap: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }

    .status-box {
      flex: 1;
      text-align: center;
      padding: 20px 15px;
      border-radius: 6px;
    }

    .status-box.on-queue {
      background: #2f8b2f;
      flex: 1.5;
    }

    .status-box.next-queue {
      background: transparent;
    }

    .status-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      margin-bottom: 8px;
      opacity: 0.9;
    }

    .status-number {
      font-size: 48px;
      font-weight: bold;
      line-height: 1;
    }

    /* Scrollbar Styling */
    .queue-grid::-webkit-scrollbar {
      width: 8px;
    }

    .queue-grid::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }

    .queue-grid::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }

    .queue-grid::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* Responsive */
    @media (max-width: 900px) {
      .container {
        flex-direction: column;
      }
      
      .queue-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .status-number {
        font-size: 36px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="main-header">
    <div class="header-title"><a href="../">SDOIN Queueing Management System</a></div>
    <div class="header-datetime" id="headerDateTime">Loading...</div>
  </header>

  <!-- Main Container -->
  <div class="container">
    <!-- Receiving Station -->
    <div class="station receiving">
      <div class="station-header">RECEIVING STATION</div>
      
      <div class="status-panel">
        <div class="status-box on-queue">
          <div class="status-label">ON QUEUE</div>
          <div class="status-number" id="recvOnQueue">--</div>
        </div>
        <div class="status-box next-queue">
          <div class="status-label">NEXT QUEUE</div>
          <div class="status-number" id="recvNext">--</div>
        </div>
      </div>

      <div class="queue-grid" id="receivingTickets">
        <!-- Populated by JavaScript -->
      </div>
    </div>

    <!-- Releasing Station -->
    <div class="station releasing">
      <div class="station-header">RELEASING STATION</div>
      
      <div class="status-panel">
        <div class="status-box on-queue">
          <div class="status-label">ON QUEUE</div>
          <div class="status-number" id="relOnQueue">--</div>
        </div>
        <div class="status-box next-queue">
          <div class="status-label">NEXT QUEUE</div>
          <div class="status-number" id="relNext">--</div>
        </div>
      </div>

      <div class="queue-grid" id="releasingTickets">
        <!-- Populated by JavaScript -->
      </div>
    </div>
  </div>

  <script>
    // Function to update date/time
    function updateDateTime() {
      const now = new Date();
      const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN',
                      'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
      const month = months[now.getMonth()];
      const day = now.getDate().toString().padStart(2, '0');
      const year = now.getFullYear();

      let hours = now.getHours();
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const seconds = now.getSeconds().toString().padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = (hours % 12 || 12).toString().padStart(2, '0');

      const dateString = `${month} ${day}, ${year}`;
      const timeString = `${hours}:${minutes}:${seconds} ${ampm}`;

      document.getElementById('headerDateTime').textContent = `${dateString} | ${timeString}`;
    }

    // Render queue numbers from localStorage (FIFO order)
    function renderTickets(containerId, queueData, currentNumber, nextNumber) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      
      if (!queueData || queueData.length === 0) {
        return;
      }

      // Sort by timestamp to maintain FIFO order (oldest first)
      const sortedQueue = queueData.sort((a, b) => (a.createdAt || a.timestamp) - (b.createdAt || b.timestamp));

      // Filter out current and next queue numbers from pending display
      const pendingQueue = sortedQueue.filter(item => {
        const itemNumber = item.number || item.queueNumber;
        return itemNumber !== currentNumber && itemNumber !== nextNumber;
      });

      // Calculate dynamic sizing based on number of items
      const itemCount = pendingQueue.length;
      let fontSize = '28px';
      let padding = '15px 10px';
      let minHeight = '60px';
      
      if (itemCount > 20) {
        fontSize = '18px';
        padding = '8px 6px';
        minHeight = '40px';
      } else if (itemCount > 15) {
        fontSize = '20px';
        padding = '10px 8px';
        minHeight = '45px';
      } else if (itemCount > 10) {
        fontSize = '24px';
        padding = '12px 8px';
        minHeight = '50px';
      }

      pendingQueue.forEach(item => {
        const queueBox = document.createElement('div');
        queueBox.className = 'queue-number';
        queueBox.style.fontSize = fontSize;
        queueBox.style.padding = padding;
        queueBox.style.minHeight = minHeight;
        queueBox.textContent = item.number || item.queueNumber;
        container.appendChild(queueBox);
      });
    }

    // Update queue status with FIFO logic
    function updateQueueStatus() {
      // Get receiving queue
      const receivingQueue = JSON.parse(localStorage.getItem('receiving_queue') || '[]');
      const receivingPending = receivingQueue.filter(item => item.status === 'pending');
      
      // Get releasing queue
      const releasingQueue = JSON.parse(localStorage.getItem('releasing_queue') || '[]');
      const releasingPending = releasingQueue.filter(item => item.status === 'pending');

      // Sort by timestamp for FIFO (oldest first)
      const sortedReceiving = receivingPending.sort((a, b) => (a.createdAt || a.timestamp) - (b.createdAt || b.timestamp));
      const sortedReleasing = releasingPending.sort((a, b) => (a.createdAt || a.timestamp) - (b.createdAt || b.timestamp));

      // Update receiving station (FIFO - first in, first out)
      let recvCurrent = '--';
      let recvNext = '--';
      if (sortedReceiving.length > 0) {
        recvCurrent = sortedReceiving[0].number || sortedReceiving[0].queueNumber;
        recvNext = sortedReceiving.length > 1 ? (sortedReceiving[1].number || sortedReceiving[1].queueNumber) : '--';
      }
      document.getElementById('recvOnQueue').textContent = recvCurrent;
      document.getElementById('recvNext').textContent = recvNext;

      // Update releasing station (FIFO - first in, first out)
      let relCurrent = '--';
      let relNext = '--';
      if (sortedReleasing.length > 0) {
        relCurrent = sortedReleasing[0].number || sortedReleasing[0].queueNumber;
        relNext = sortedReleasing.length > 1 ? (sortedReleasing[1].number || sortedReleasing[1].queueNumber) : '--';
      }
      document.getElementById('relOnQueue').textContent = relCurrent;
      document.getElementById('relNext').textContent = relNext;

      // Render tickets (show pending tickets excluding current and next)
      renderTickets('receivingTickets', sortedReceiving, recvCurrent, recvNext);
      renderTickets('releasingTickets', sortedReleasing, relCurrent, relNext);
    }

    // Initialize and update time every second
    document.addEventListener('DOMContentLoaded', function() {
      updateDateTime();
      setInterval(updateDateTime, 1000);
      updateQueueStatus();
      
      // Update queue status every 2 seconds
      setInterval(updateQueueStatus, 2000);
    });

    // Listen for storage changes (when other tabs update queues)
    window.addEventListener('storage', function(e) {
      if (e.key === 'receiving_queue' || e.key === 'releasing_queue' || 
          e.key === 'receiving_last_update' || e.key === 'releasing_last_update') {
        updateQueueStatus();
      }
    });

    // Also listen for custom events (for same-tab updates)
    window.addEventListener('queueUpdated', function() {
      updateQueueStatus();
    });
  </script>
</body>
</html>